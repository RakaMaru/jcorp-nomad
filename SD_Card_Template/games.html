<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="Jcorp Nomad Media Server ‚Äì Games">
  <title>Nomad ‚Ä¢ Games</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --bg: #f4f4f9;
      --text: #333;
      --radius: 8px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    *,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    header {
      background: var(--primary);
      color:#fff;
      padding:1.25rem 1rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: var(--shadow);
      position:sticky;
      top:0;
      z-index:50;
      flex-wrap:wrap;
    }
    header h1 {
      font-size:clamp(1.25rem,5vw,1.75rem);
      font-weight:600;
    }
    .back-btn {
      text-decoration:none;
      color:#fff;
      background:var(--primary-dark);
      padding:.5rem .75rem;
      border-radius:var(--radius);
      font-size:.9rem;
    }
    .toolbar {
      background:var(--bg);
      padding:.75rem 1rem;
      display:flex;
      flex-wrap:wrap;
      gap:.75rem;
      align-items:center;
      border-bottom:1px solid #ddd;
      position:sticky;
      top:64px;
      z-index:45;
    }
    .toolbar input[type="search"] {
      flex:1 1 200px;
      padding:.5rem .75rem;
      border:1px solid #ccc;
      border-radius:var(--radius);
      font-size:.95rem;
      line-height:1.25;
      max-height:2.5rem;
    }
    .toolbar select,
    .toolbar .view-btn {
      padding:.5rem .75rem;
      border:1px solid #ccc;
      background:#fff;
      border-radius:var(--radius);
      font-size:.9rem;
      cursor:pointer;
    }
    .view-btn.active {
      background:var(--primary);
      color:#fff;
      border-color:var(--primary-dark);
    }
    main {
      flex:1;
      display:flex;
      flex-direction:column;
      max-width:1200px;
      width:100%;
      margin:0 auto;
    }
    .grid-wrapper {
      flex:1;
      overflow-y:auto;
      padding:1rem;
    }
    .media-grid { display:grid; gap:1rem; }
    .media-grid.small  { grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); }
    .media-grid.medium { grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); }
    .media-grid.large  { grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    @media(max-width:600px) {
      header { flex-direction:column; align-items:stretch; }
      .back-btn { width:100%; text-align:center; }
      .toolbar { top:112px; flex-direction:column; align-items:stretch; }
      .media-grid.small,
      .media-grid.medium,
      .media-grid.large { grid-template-columns:repeat(2,1fr); }
    }
    .media-card {
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      transition:transform .25s ease;
      cursor:pointer;
      width:100%;
      max-width:220px;
      margin:0 auto;
    }
    .media-card:hover { transform:translateY(-3px); }
    .media-thumb {
      width:100%;
      aspect-ratio:2/3;
      object-fit:cover;
    }
    .media-caption {
      padding:.5rem;
      text-align:center;
    }
    .media-caption small {
      display:block;
      font-size:.75rem;
      color:#666;
    }
    #emu {
      display:none;
      width:100%;
      height:calc(100vh - 60px);
      background:#000;
      position:relative;
    }
    footer {
      text-align:center;
      padding:1rem 0;
      font-size:0.9rem;
      color:#666;
    }
  </style>
</head>
<body>
  <header>
    <h1>Games</h1>
    <a class="back-btn" href="/menu">‚Üê Back to Menu</a>
  </header>

  <div class="toolbar">
    <input id="searchInput" type="search" placeholder="Search games‚Ä¶" aria-label="Search games">
    <select id="consoleSelect" aria-label="Filter by console">
      <option value="">All Consoles</option>
      <option value="nes">NES</option>
      <option value="snes">SNES</option>
      <option value="gba">GBA</option>
      <option value="gb">GB</option>
      <option value="gbc">GBC</option>
      <option value="n64">N64</option>
      <option value="genesis">Genesis</option>
      <option value="sms">Master System</option>
      <option value="psx">PlayStation</option>
    </select>
    <select id="sortSelect" aria-label="Sort games">
      <option value="nameAsc">A ‚Üí Z</option>
      <option value="nameDesc">Z ‚Üí A</option>
    </select>
    <div style="display:flex;gap:.5rem;">
      <button class="view-btn" data-size="small" title="Compact view">üî≥</button>
      <button class="view-btn active" data-size="medium" title="Comfort view">üî≤</button>
      <button class="view-btn" data-size="large" title="Gallery view">‚¨ú</button>
    </div>
  </div>

  <main>
    <div class="grid-wrapper">
      <div id="grid" class="media-grid medium"></div>
      <div id="emu"></div>
    </div>
  </main>

  <footer>¬© <span id="year"></span> Jcorp Nomad</footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const grid          = document.getElementById('grid');
    const emuEl         = document.getElementById('emu');
    const searchInput   = document.getElementById('searchInput');
    const consoleSelect = document.getElementById('consoleSelect');
    const sortSelect    = document.getElementById('sortSelect');
    const viewButtons   = document.querySelectorAll('.view-btn');

    let games         = [];
    let filtered      = [];
    let debounceTimer = null;
    let currentSize   = localStorage.getItem('nomadGamesSize') || 'medium';

    function setViewSize(size) {
      currentSize = size;
      grid.className = `media-grid ${size}`;
      viewButtons.forEach(b => b.classList.toggle('active', b.dataset.size === size));
      localStorage.setItem('nomadGamesSize', size);
    }
    setViewSize(currentSize);
    viewButtons.forEach(b => b.addEventListener('click', () => setViewSize(b.dataset.size)));

    function deriveCore(path) {
      const filename = path.split('/').pop().toLowerCase();
      const parts = filename.split('.');
      let ext = parts.pop();
      if (['zip','iso','bin','7z','rar'].includes(ext) && parts.length) ext = parts.pop();
      switch (ext) {
        case 'nes':   return 'nes';
        case 'sfc': case 'smc': return 'snes';
        case 'gba':   return 'gba';
        case 'gb':    return 'gb';
        case 'gbc':   return 'gbc';
        case 'n64':   return 'n64';
        case 'gen': case 'md': return 'genesis';
        case 'sms':   return 'sms';
        case 'psx': case 'ps1': return 'psx';
        default:      return '';
      }
    }

    async function init() {
      try {
        const res  = await fetch('/media.json');
        const json = await res.json();

        let raw = json.games || json.Games;
        if (!Array.isArray(raw)) {
          raw = Object.values(json)
            .filter(a => Array.isArray(a))
            .flat()
            .filter(item => item.file && item.file.toLowerCase().startsWith('games/'));
        }

        games = raw.map(g => {
          const file = g.file.startsWith('/') ? g.file : '/' + g.file;
          return {
            name:  g.name,
            cover: g.cover || 'placeholder.jpg',
            file:  file,
            core:  deriveCore(file)
          };
        });

        applyFilters();
      } catch (err) {
        console.error('Failed to load media.json:', err);
        grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#666;">Could not load games.</p>';
      }
    }

    function applyFilters() {
      const txt = searchInput.value.trim().toLowerCase();
      const sys = consoleSelect.value;
      filtered = games.filter(game => {
        const okText = game.name.toLowerCase().includes(txt);
        const okSys  = !sys || game.core === sys;
        return okText && okSys;
      });
      applySort(sortSelect.value);
    }

    function applySort(mode) {
      filtered.sort((a,b) =>
        mode === 'nameDesc'
          ? b.name.localeCompare(a.name)
          : a.name.localeCompare(b.name)
      );
      render();
    }

    function render() {
      grid.innerHTML = '';
      grid.className = `media-grid ${currentSize}`;
      emuEl.style.display = 'none';
      if (!filtered.length) {
        grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#666;">No games found.</p>';
        return;
      }
      filtered.forEach((game, idx) => {
        const card = document.createElement('div');
        card.className = 'media-card';
        card.innerHTML = `
          <img class="media-thumb" src="${game.cover}" alt="${game.name}">
          <div class="media-caption">
            <strong>${game.name}</strong>
            <small>${game.core.toUpperCase()}</small>
          </div>`;
        card.onclick = () => startGame(idx);
        grid.appendChild(card);
      });
    }

    function startGame(idx) {
      const game = filtered[idx];
      grid.parentElement.scrollTo({ top: 0 });
      grid.style.display = 'none';
      emuEl.style.display = 'block';
      emuEl.innerHTML = '';

      window.EJS_player     = '#emu';
      window.EJS_gameUrl    = game.file;
      window.EJS_core       = game.core;
      window.EJS_pathtodata = '/EmulatorJS/data/';
      window.EJS_gameName   = game.name;
      window.EJS_biosUrl    = '';
      window.EJS_lightgun   = false;

      const loader = document.createElement('script');
      loader.src = '/EmulatorJS/loader.js';
      document.body.appendChild(loader);
    }

    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(applyFilters, 150);
    });
    consoleSelect.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', () => applySort(sortSelect.value));

    init();
  </script>
</body>
</html>
