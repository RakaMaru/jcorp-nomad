<!DOCTYPE html>
<!--  Nomad Shows Page  -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="Jcorp Nomad Media Server ‚Äì Shows">
  <title>Nomad ‚Ä¢ Shows</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <style>
    :root{--primary:#007bff;--primary-dark:#0056b3;--bg:#f4f4f9;--text:#333;--radius:8px;--shadow:0 4px 12px rgba(0,0,0,0.08);} 
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;min-height:100vh;}
    header{background:var(--primary);color:#fff;padding:1.25rem 1rem;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow);position:sticky;top:0;z-index:50;}
    header h1{font-size:clamp(1.25rem,5vw,1.75rem);font-weight:600;white-space:nowrap;}
    .back-btn{text-decoration:none;color:#fff;background:var(--primary-dark);padding:.5rem .75rem;border-radius:var(--radius);font-size:0.9rem;white-space:nowrap;}

    .toolbar{background:var(--bg);padding:.75rem 1rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;border-bottom:1px solid #ddd;position:sticky;top:64px;z-index:45;}
    .toolbar input[type="search"],.toolbar select{padding:.5rem .75rem;border:1px solid #ccc;border-radius:var(--radius);font-size:0.95rem;}
    .toolbar input[type="search"]{flex:1 1 200px;}
    .view-btn{padding:.5rem .75rem;border:1px solid #ccc;background:#fff;border-radius:var(--radius);font-size:0.9rem;cursor:pointer;}
    .view-btn.active{background:var(--primary);color:#fff;border-color:var(--primary-dark);}  

    main{flex:1;display:flex;flex-direction:column;max-width:1200px;width:100%;margin:0 auto;}
    .grid-wrapper{flex:1;overflow-y:auto;padding:1rem;}
    .media-grid{display:grid;gap:1rem;}
    .media-grid.small {grid-template-columns:repeat(auto-fit,minmax(120px,1fr));}
    .media-grid.medium{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
    .media-grid.large {grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}

    @media(max-width:600px){
      header{flex-direction:column;gap:.5rem;}
      .back-btn{width:100%;text-align:center;}
      .toolbar{top:112px;}
      .media-grid.small{grid-template-columns:repeat(2,1fr);}
      .media-grid.medium{grid-template-columns:repeat(3,1fr);}
      .media-grid.large{grid-template-columns:repeat(4,1fr);}
    }

    .media-card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform .25s ease;cursor:pointer;width:100%;max-width:220px;margin:0 auto;}
    .media-grid.small  .media-card{max-width:120px;}
    .media-grid.medium .media-card{max-width:160px;}
    .media-grid.large  .media-card{max-width:220px;}
    .media-card:hover{transform:translateY(-3px);}  
    .media-thumb{width:100%;aspect-ratio:2/3;object-fit:cover;}
    
    .modal,.episode-modal,.video-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:1000;}
    .modal-content,.episode-modal-content,.video-modal-content{background:#fff;padding:20px;border-radius:10px;text-align:center;width:90%;max-width:600px;box-shadow:0 6px 20px rgba(0,0,0,0.1);}  
    .modal button,.episode-modal button,.video-modal button{padding:12px;font-size:1em;margin:10px 0;background:var(--primary);color:#fff;border:none;border-radius:5px;cursor:pointer;width:100%;transition:background .2s;}
    .modal button:hover,.episode-modal button:hover,.video-modal button:hover{background:var(--primary-dark);}  
    .episode-list{max-height:400px;overflow-y:auto;text-align:left;}
    .episode-list button{width:100%;margin:5px 0;padding:10px;font-size:1em;}

    .video-container{display:flex;flex-direction:column;align-items:center;gap:1rem;}
    video{width:100%;max-width:800px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.2);}  
    #nextBtn{margin-top:.5rem;}
  </style>
</head>
<body>
  <header>
    <h1>Shows</h1>
    <a class="back-btn" href="http://192.168.4.1/menu">‚Üê Back to Menu</a>
  </header>

  <div class="toolbar">
    <input id="searchInput" type="search" placeholder="Search shows‚Ä¶" aria-label="Search shows">
    <select id="sortSelect" aria-label="Sort shows">
      <option value="nameAsc">A ‚Üí Z</option>
      <option value="nameDesc">Z ‚Üí A</option>
    </select>
    <button class="view-btn" data-size="small">üî≥</button>
    <button class="view-btn active" data-size="medium">üî≤</button>
    <button class="view-btn" data-size="large">‚¨ú</button>
  </div>

  <main>
    <div class="grid-wrapper">
      <div id="grid" class="media-grid medium"></div>
    </div>
  </main>

  <div id="episodeModal" class="episode-modal">
    <div class="episode-modal-content">
      <h2>Select an Episode</h2>
      <div id="episodeList" class="episode-list"></div>
      <button onclick="closeEpisodeModal()">Close</button>
    </div>
  </div>

  <div id="modal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation();">
      <h2>What would you like to do?</h2>
      <button id="viewButton">Watch</button>
      <button id="downloadButton">Download</button>
    </div>
  </div>

  <div id="videoModal" class="video-modal">
    <div class="video-modal-content">
      <div class="video-container">
        <video id="videoPlayer" controls preload="metadata"></video>
        <button id="nextBtn">Next Episode ‚ñ∂</button>
        <button onclick="closeVideo()">Close</button>
      </div>
    </div>
  </div>

  <footer>¬© <span id="year"></span>¬†Jcorp Nomad</footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const videoFormats = ['.mp4','.mkv','.avi','.mov','.webm'];
    let shows = [], filtered = [], flattened = [], currentIdx = 0;

    const grid          = document.getElementById('grid');
    const searchInput   = document.getElementById('searchInput');
    const sortSelect    = document.getElementById('sortSelect');
    const viewBtns      = [...document.querySelectorAll('.view-btn')];
    const episodeModal  = document.getElementById('episodeModal');
    const episodeList   = document.getElementById('episodeList');
    const actionModal   = document.getElementById('modal');
    const videoModal    = document.getElementById('videoModal');
    const videoPlayer   = document.getElementById('videoPlayer');
    const nextBtn       = document.getElementById('nextBtn');

    let curSize = localStorage.getItem('nomadShowsSize') || 'medium';
    function setViewSize(sz) {
      curSize = sz;
      viewBtns.forEach(b => b.classList.toggle('active', b.dataset.size === sz));
      grid.className = `media-grid ${sz}`;
      localStorage.setItem('nomadShowsSize', sz);
    }
    viewBtns.forEach(b => b.addEventListener('click', () => setViewSize(b.dataset.size)));
    setViewSize(curSize);

    function isVideo(f) {
      return videoFormats.some(ext => f.toLowerCase().endsWith(ext));
    }
    function mediaUrl(fp) {
      return `/media?file=${encodeURIComponent('/' + fp)}`;
    }
    function downloadUrl(fp) {
      return `/media.json?file=${encodeURIComponent('/' + fp)}`;
    }
    function flattenShow(s) {
      if (s.episodes) return s.episodes;
      return s.seasons?.flatMap(se => se.episodes || []) || [];
    }

    fetch('/media.json')
      .then(r => r.json())
      .then(data => { shows = data.shows || []; applyFilter(''); })
      .catch(_ => {
        grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--primary-dark);">Unable to load content.</p>';
      });

    let debounce;
    function applyFilter(q) {
      const term = q.trim().toLowerCase();
      filtered = !term ? [...shows] : shows.filter(s => s.name.toLowerCase().includes(term));
      applySort(sortSelect.value);
    }
    function applySort(mode) {
      filtered.sort((a, b) =>
        mode === 'nameDesc'
          ? b.name.localeCompare(a.name)
          : a.name.localeCompare(b.name)
      );
      renderGrid();
    }
    searchInput.addEventListener('input', e => {
      clearTimeout(debounce);
      debounce = setTimeout(() => applyFilter(e.target.value), 150);
    });
    sortSelect.addEventListener('change', () => applySort(sortSelect.value));

    function renderGrid() {
      grid.className = `media-grid ${curSize}`;
      const f = document.createDocumentFragment();
      if (!filtered.length) {
        grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--primary-dark);">No shows found.</p>';
        return;
      }
      filtered.forEach(s => {
        const c = document.createElement('div');
        c.className = 'media-card';
        c.innerHTML = `<img class="media-thumb" loading="lazy" src="${s.cover||'placeholder.jpg'}" alt="${s.name}">`;
        c.onclick = () => openEpisodeModal(s);
        f.appendChild(c);
      });
      grid.innerHTML = '';
      grid.appendChild(f);
    }

    function openEpisodeModal(show) {
      flattened = flattenShow(show).filter(ep => isVideo(ep.file));
      episodeList.innerHTML = '';
      flattened.forEach((ep, i) => {
        const btn = document.createElement('button');
        btn.textContent = ep.name || `Episode ${i+1}`;
        btn.onclick = () => openActionModal(i);
        episodeList.appendChild(btn);
      });
      episodeModal.style.display = 'flex';
    }
    function closeEpisodeModal() {
      episodeModal.style.display = 'none';
    }

    function openActionModal(i) {
      currentIdx = i;
      actionModal.style.display = 'flex';
      document.getElementById('viewButton').onclick = () => {
        playEpisode(i);
        actionModal.style.display = 'none';
      };
      document.getElementById('downloadButton').onclick = () => {
        const link = document.createElement('a');
        link.href = downloadUrl(flattened[i].file);
        link.download = flattened[i].name || `Episode${i+1}`;
        link.click();
        actionModal.style.display = 'none';
      };
    }
    function closeModal(e) {
      if (e.target === actionModal) actionModal.style.display = 'none';
    }

    const MAX_RETRIES = 2;
    const STALL_DELAY = 8000;
    let retryCount = 0, stallTimer = null, lastSrc = null;

    function startStallWatcher(p, src) {
      clearTimeout(stallTimer);
      retryCount = 0;
      lastSrc    = src;

      function schedule() {
        clearTimeout(stallTimer);
        stallTimer = setTimeout(() => {
          if (!p.paused && p.readyState < 3 && retryCount < MAX_RETRIES) {
            retryCount++;
            console.log(`[Nomad] Stall ‚Üí retry #${retryCount}`);
            p.src = `${lastSrc}${lastSrc.includes('?')?'&':'?'}_=${Date.now()}`;
            p.load();
            p.currentTime = p.currentTime;
            p.play().catch(()=>{});
            schedule();
          }
        }, STALL_DELAY);
      }

      p.addEventListener('playing', function once() {
        p.removeEventListener('playing', once);
        schedule();
      });
      p.addEventListener('pause',  () => clearTimeout(stallTimer));
      p.addEventListener('ended',  () => clearTimeout(stallTimer));
    }

    function playEpisode(idx) {
      if (idx < 0 || idx >= flattened.length) return;
      currentIdx = idx;
      const ep = flattened[idx];
      videoPlayer.pause();
      videoPlayer.removeAttribute('src');
      videoPlayer.load();
      videoModal.style.display = 'flex';

      const url = mediaUrl(ep.file);
      videoPlayer.src = url;
      startStallWatcher(videoPlayer, url);
      videoPlayer.play().catch(()=>{});
    }
    function closeVideo() {
      videoPlayer.pause();
      videoPlayer.removeAttribute('src');
      videoPlayer.load();
      videoModal.style.display = 'none';
    }

    nextBtn.onclick = () => playEpisode(currentIdx + 1);
    videoPlayer.addEventListener('ended', () => playEpisode(currentIdx + 1));

  </script>
</body>
</html>
