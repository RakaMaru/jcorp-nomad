<!DOCTYPE html>
<!--  Nomad Books Page -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Jcorp Nomad Media Server ‚Äì Books">
    <title>Nomad ‚Ä¢ Books</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="epub.min.js"></script>
    <style>
        :root{--primary:#007bff;--primary-dark:#0056b3;--bg:#f4f4f9;--text:#333;--radius:8px;--shadow:0 4px 12px rgba(0,0,0,0.08);}        
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
        body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;min-height:100vh;}

        /* Header */
        header{background:var(--primary);color:#fff;padding:1.25rem 1rem;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow);position:sticky;top:0;z-index:50;}
        header h1{font-size:clamp(1.25rem,5vw,1.75rem);font-weight:600;white-space:nowrap;}
        .back-btn{text-decoration:none;color:#fff;background:var(--primary-dark);padding:.5rem .75rem;border-radius:var(--radius);font-size:.9rem;white-space:nowrap;}

        /* Toolbar */
        .toolbar{background:var(--bg);padding:.75rem 1rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;border-bottom:1px solid #ddd;position:sticky;top:64px;z-index:45;}
        .toolbar input[type="search"]{flex:1 1 200px;padding:.5rem .75rem;border:1px solid #ccc;border-radius:var(--radius);font-size:.95rem;}
        .toolbar select,.toolbar .view-btn{padding:.5rem .75rem;border:1px solid #ccc;background:#fff;border-radius:var(--radius);font-size:.9rem;cursor:pointer;}
        .view-btn.active{background:var(--primary);color:#fff;border-color:var(--primary-dark);}        

        /* Grid */
        main{flex:1;display:flex;flex-direction:column;max-width:1200px;width:100%;margin:0 auto;}
        .grid-wrapper{flex:1;overflow-y:auto;padding:1rem;}
        .media-grid{display:grid;gap:1rem;}
        .media-grid.small {grid-template-columns:repeat(auto-fit,minmax(120px,1fr));}
        .media-grid.medium{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
        .media-grid.large {grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
        @media(max-width:600px){
            header{flex-direction:column;gap:.5rem;}
            .back-btn{width:100%;text-align:center;}
            .toolbar{top:112px;}
            .media-grid.small  {grid-template-columns:repeat(2,1fr);} /* 2 per row */
            .media-grid.medium {grid-template-columns:repeat(3,1fr);} /* 3 per row */
            .media-grid.large  {grid-template-columns:repeat(4,1fr);} /* 4 per row */
        }

        .media-card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform .25s ease;cursor:pointer;width:100%;max-width:220px;margin:0 auto;}
        .media-grid.small  .media-card{max-width:120px;}
        .media-grid.medium .media-card{max-width:160px;}
        .media-grid.large  .media-card{max-width:220px;}
        .media-card:hover{transform:translateY(-3px);}        
        .media-thumb{width:100%;aspect-ratio:2/3;object-fit:cover;}
        

        /* Action Modal */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:1000;}
        .modal-content{background:#fff;padding:20px;border-radius:10px;text-align:center;width:90%;max-width:500px;box-shadow:0 6px 20px rgba(0,0,0,0.1);}        
        .modal-content h2{margin-bottom:10px;font-size:1.25rem;}
        .modal-content button{padding:12px;font-size:1em;margin:10px 0;background:var(--primary);color:#fff;border:none;border-radius:5px;cursor:pointer;width:100%;transition:background-color .3s ease;}
        .modal-content button:hover{background:var(--primary-dark);}        

        .modal-content button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header><h1>Books</h1><a class="back-btn" href="http://192.168.4.1/menu">‚Üê Back to Menu</a></header>

    <!-- Toolbar -->
    <div class="toolbar">
        <input id="searchInput" type="search" placeholder="Search books‚Ä¶" aria-label="Search books">
        <select id="sortSelect" aria-label="Sort books">
            <option value="nameAsc">A ‚Üí Z</option>
            <option value="nameDesc">Z ‚Üí A</option>
        </select>
        <button class="view-btn"  data-size="small"  title="Compact view">üî≥</button>
        <button class="view-btn active" data-size="medium" title="Comfort view">üî≤</button>
        <button class="view-btn"  data-size="large"  title="Gallery view">‚¨ú</button>
    </div>

    <!-- Grid -->
    <main><div class="grid-wrapper"><div id="grid" class="media-grid medium"></div></div></main>

    <!-- View / Download Modal -->
    <div id="modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation();">
            <h2 id="modalTitle">What would you like to do?</h2>
            <button id="viewButton">View in Browser</button>
            <button id="downloadButton">Download</button>
            <p id="modalNote" style="margin-top:0.5rem;color:#555;font-size:.9rem;display:none;"></p>
        </div>
    </div>

    <footer>¬© <span id="year"></span>¬†Jcorp Nomad</footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        const searchInput = document.getElementById('searchInput');
        const sortSelect  = document.getElementById('sortSelect');
        const gridElement = document.getElementById('grid');
        const viewButtons = document.querySelectorAll('.view-btn');
        const modal       = document.getElementById('modal');
        const viewBtn     = document.getElementById('viewButton');
        const downloadBtn = document.getElementById('downloadButton');

        const fileExt = f=>f.slice(f.lastIndexOf('.')).toLowerCase();
        const booksKey = 'nomadBooksSize';
        let books = [], filtered = [], debounceTimer = null, currentBook = null;

        let currentSize = localStorage.getItem(booksKey) || 'medium';
        function setViewSize(size){
            currentSize = size;
            viewButtons.forEach(btn=>btn.classList.toggle('active', btn.dataset.size===size));
            gridElement.className = `media-grid ${size}`;
            localStorage.setItem(booksKey, size);
        }
        setViewSize(currentSize);
        viewButtons.forEach(btn=>btn.addEventListener('click',()=>setViewSize(btn.dataset.size)));

        async function init(){
            try{
                const res = await fetch('/media.json');
                const json = await res.json();
                const raw  = json.books || json.Books || [];
                books = raw.map(b=>({
                    name : b.name  || b.title || 'Unknown',
                    cover: b.cover || b.thumbnail || 'placeholder.jpg',
                    path : b.file  || b.path || b.url || ''
                })).filter(b=>b.path);
                applyFilter('');
            }catch(err){
                console.error('Media load error', err);
                gridElement.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--primary-dark);">Unable to load content.</p>';
            }
        }

        function applyFilter(term){
            const lower = term.trim().toLowerCase();
            filtered = !lower ? [...books] : books.filter(b=>b.name.toLowerCase().includes(lower));
            applySort(sortSelect.value);
        }
        function applySort(mode){
            if(mode==='nameDesc'){filtered.sort((a,b)=>b.name.localeCompare(a.name));}
            else{filtered.sort((a,b)=>a.name.localeCompare(b.name));}
            renderGrid();
        }
        function renderGrid(){
            gridElement.className = `media-grid ${currentSize}`;
            const frag=document.createDocumentFragment();
            filtered.forEach(item=>{
                const card=document.createElement('div');
                card.className='media-card';
                card.innerHTML=`<img class="media-thumb" loading="lazy" src="${item.cover}" alt="${item.name}">`;
                card.addEventListener('click',()=>showBookOptions(item));
                frag.appendChild(card);
            });
            gridElement.innerHTML='';
            gridElement.appendChild(frag);
        }

        function showBookOptions(book){
            currentBook = book;
            const ext     = fileExt(book.path);
            const noteEl  = document.getElementById('modalNote');
            const titleEl = document.getElementById('modalTitle');

            titleEl.textContent = `What would you like to do with "${book.name}"?`;

            if (ext === '.epub') {
            // EPUB-specific UI
            viewBtn.textContent = 'Not supported';
            viewBtn.disabled   = true;
            viewBtn.title      = 'EPUBs need to be downloaded and read in a separate app';

            // Show disclaimer
            noteEl.textContent   = 'In‚Äëbrowser reading of EPUBs is not supported. Please download and open in an EPUB reader.';
            noteEl.style.display = 'block';

            } else {
            // Other files (PDF, etc.)
            viewBtn.textContent = 'View in Browser';
            viewBtn.disabled   = false;
            viewBtn.title      = '';

            // Hide disclaimer
            noteEl.textContent   = '';
            noteEl.style.display = 'none';
            }

            downloadBtn.textContent = 'Download';    // ensure download label
            modal.style.display     = 'flex';
        }

        function closeModal(evt){if(evt.target===modal){modal.style.display='none';}}
        viewBtn.onclick = ()=>{ 
        if (!currentBook) return;

        const ext = fileExt(currentBook.path);
        if (ext !== '.epub') {
            openBook(currentBook);
        }
        modal.style.display = 'none';
        };
        downloadBtn.onclick = ()=>{ if(currentBook){ downloadBook(currentBook);} modal.style.display='none'; };

        function openBook(book){
            const ext = fileExt(book.path);
            let url;

            if (ext === '.epub') {
         
            url = `/reader.html?file=${encodeURIComponent(book.path)}`;
            } else {
            // PDF (and all others) direct file URL
            url = book.path;
            }

            window.open(url, '_blank');
        }
        function downloadBook(book) {
            const a = document.createElement('a');
            a.href = book.path;

            let filename = book.path.substring(book.path.lastIndexOf('/') + 1);

            a.download = filename;  // Force download with proper filename and extension
            a.click();
        }

        searchInput.addEventListener('input', e=>{clearTimeout(debounceTimer); debounceTimer = setTimeout(()=>applyFilter(e.target.value),150);} );
        sortSelect.addEventListener('change', ()=>applySort(sortSelect.value));

        init();
function renderGrid() {
    gridElement.className = `media-grid ${currentSize}`;
    const frag = document.createDocumentFragment();

    filtered.forEach(item => {
        const cleanName = (item.name || 'Unknown').replace(/\.[^/.]+$/, ""); // no extension
        const coverSrc = item.cover || 'placeholder.jpg';

        const card = document.createElement('div');
        card.className = 'media-card';

        card.innerHTML = `
          <div class="thumb-wrapper" style="position:relative;display:flex;align-items:center;justify-content:center;background:#eee;color:#555;font-size:0.9rem;text-align:center;width:100%;aspect-ratio:2/3;">
            <span class="fallback-text" style="padding:0.5rem;position:absolute;z-index:2;text-align:center;">${cleanName}</span>
            <img class="media-thumb" loading="lazy" src="${coverSrc}" alt="${item.name}" 
                 style="width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;z-index:1;opacity:0;transition:opacity 0.3s ease;">
          </div>
        `;

        const img = card.querySelector('img');
        const fallback = card.querySelector('.fallback-text');

        img.onload = () => {
            img.style.opacity = '1';
            fallback.style.display = 'none';
        };

        img.onerror = () => {
            img.style.display = 'none';
            fallback.style.display = 'block';
        };

        card.addEventListener('click', () => showBookOptions(item));
        frag.appendChild(card);
    });

    gridElement.innerHTML = '';
    gridElement.appendChild(frag);
}

    </script>
</body>
</html>
