<!DOCTYPE html>
<!--  Nomad Movies Page (mobile grid + replay fix + search layout fix)  -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Jcorp Nomad Media Server ‚Äì Movies">
    <title>Nomad Movies</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <style>
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --bg: #f4f4f9;
            --text: #333;
            --radius: 8px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
        body{font-family: Arial, sans-serif;background: var(--bg);color: var(--text);display:flex;flex-direction:column;min-height:100vh;}
        header{background: var(--primary);color:#fff;padding:1.25rem 1rem;display:flex;align-items:center;justify-content:space-between;box-shadow: var(--shadow);position:sticky;top:0;z-index:50;}
        header h1{font-size:clamp(1.25rem,5vw,1.75rem);font-weight:600;white-space:nowrap;}
        .back-btn{text-decoration:none;color:#fff;background:var(--primary-dark);padding:.5rem .75rem;border-radius:var(--radius);font-size:0.9rem;white-space:nowrap;}

        .toolbar{background:var(--bg);padding:.75rem 1rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;border-bottom:1px solid #ddd;position:sticky;top:64px;z-index:45;}
        .toolbar input[type="search"]{flex:1 1 200px;padding:.5rem .75rem;border:1px solid #ccc;border-radius:var(--radius);font-size:0.95rem;}
        .toolbar select, .toolbar .view-btn{padding:.5rem .75rem;border:1px solid #ccc;background:#fff;border-radius:var(--radius);font-size:0.9rem;cursor:pointer;}
        .view-btn.active{background:var(--primary);color:#fff;border-color:var(--primary-dark);}
        main{flex:1;display:flex;flex-direction:column;max-width:1200px;width:100%;margin:0 auto;}
        .grid-wrapper{flex:1;overflow-y:auto;padding:1rem;}

        .media-grid{display:grid;gap:1rem;}
        .media-grid.small {grid-template-columns:repeat(auto-fit,minmax(120px,1fr));}
        .media-grid.medium{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
        .media-grid.large {grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}

        @media (max-width:600px){
            header{flex-direction:column;gap:.5rem;}
            .back-btn{width:100%;text-align:center;}
            .toolbar{top:112px;}
            .media-grid.small  {grid-template-columns:repeat(2,1fr);} /* 2 per row */
            .media-grid.medium {grid-template-columns:repeat(3,1fr);} /* 3 per row */
            .media-grid.large  {grid-template-columns:repeat(4,1fr);} /* 4 per row */
        }

        .media-card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform .25s ease;cursor:pointer;width:100%;max-width:220px;margin:0 auto;}
        .media-grid.small  .media-card{max-width:120px;}
        .media-grid.medium .media-card{max-width:160px;}
        .media-grid.large  .media-card{max-width:220px;}
        .media-card:hover{transform:translateY(-3px);}        
        .media-thumb{width:100%;aspect-ratio:2/3;object-fit:cover;}
        

        .modal,.video-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:1000;}
        .modal-content,.video-modal-content{background:#fff;padding:20px;border-radius:10px;text-align:center;width:90%;max-width:500px;box-shadow:0 6px 20px rgba(0,0,0,0.1);}        
        .modal button,.video-modal button{padding:12px;font-size:1em;margin:10px 0;background:var(--primary);color:#fff;border:none;border-radius:5px;cursor:pointer;width:100%;transition:background-color .3s ease;}
        .modal button:hover,.video-modal button:hover{background:var(--primary-dark);}        
        .video-container{display:flex;flex-direction:column;align-items:center;gap:1rem;}
        video{width:100%;max-width:800px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.2);}        

        .video-container{display:flex;flex-direction:column;align-items:center;gap:1rem;}
        video{width:100%;max-width:800px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.2);}        
    </style>
</head>
<body>
    <header><h1>Movies</h1><a class="back-btn" href="http://192.168.4.1/menu">‚Üê Back to Menu</a></header>

    <div class="toolbar">
        <input id="searchInput" type="search" placeholder="Search movies‚Ä¶" aria-label="Search movies">
        <select id="sortSelect" aria-label="Sort movies">
            <option value="nameAsc">A ‚Üí Z</option>
            <option value="nameDesc">Z ‚Üí A</option>
        </select>
        <button class="view-btn" data-size="small" title="Compact view">üî≥</button>
        <button class="view-btn active" data-size="medium" title="Comfort view">üî≤</button>
        <button class="view-btn" data-size="large" title="Gallery view">‚¨ú</button>
    </div>

    <main><div class="grid-wrapper"><div id="grid" class="media-grid medium"></div></div></main>

    <div id="modal" class="modal" onclick="closeModal(event)"><div class="modal-content" onclick="event.stopPropagation();"><h2>What would you like to do?</h2><button id="viewButton">View in Browser</button><button id="downloadButton">Download</button></div></div>

    <div id="videoModal" class="video-modal"><div class="video-modal-content"><div class="video-container"><video id="videoPlayer" controls><source id="videoSource" type="video/mp4">Your browser does not support the video tag.</video><button onclick="closeVideo()">Close</button></div></div></div>

    <footer>¬© <span id="year"></span>¬†Jcorp Nomad</footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
        const searchInput = document.getElementById('searchInput');
        const sortSelect  = document.getElementById('sortSelect');
        const gridElement = document.getElementById('grid');
        const viewButtons = document.querySelectorAll('.view-btn');
        const videoFormats = ['.mp4','.mkv','.avi','.mov','.webm'];
        const modal = document.getElementById('modal');
        const viewBtn = document.getElementById('viewButton');
        const downloadBtn = document.getElementById('downloadButton');
        const videoModal = document.getElementById('videoModal');
        const videoSource = document.getElementById('videoSource');
        const videoPlayer = document.getElementById('videoPlayer');
        let movies = [];
        let filtered = [];
        let debounceTimer = null;
        let currentMovie = null;
        let currentSize = localStorage.getItem('nomadMoviesSize') || 'medium';

        function setViewSize(size){
            currentSize = size;
            viewButtons.forEach(btn=>btn.classList.toggle('active', btn.dataset.size===size));
            gridElement.className = `media-grid ${size}`;
            localStorage.setItem('nomadMoviesSize', size);
        }
        setViewSize(currentSize);
        viewButtons.forEach(btn=>btn.addEventListener('click',()=>setViewSize(btn.dataset.size)));

        function isVideoFile(fileName){return videoFormats.some(ext=>fileName.toLowerCase().endsWith(ext));}
        function getFileUrlForView(filePath){return `/media?file=${encodeURIComponent('/'+filePath)}`;}

        async function init(){
            try{
                const res = await fetch('/media.json');
                const json = await res.json();
                const raw = json.movies || json.Movies || [];
                movies = raw.filter(m=>isVideoFile(m.file||m.path||''))
                            .map(m=>({name:m.name||m.title||'Unknown',cover:m.cover||m.thumbnail||m.poster||'placeholder.jpg',path:m.file||m.path||''}));
                applyFilter('');
            }catch(err){
                console.error('Media load error', err);
                gridElement.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--primary-dark);">Unable to load content.</p>';
            }
        }

        function applyFilter(term){const lower = term.trim().toLowerCase();filtered = !lower ? [...movies] : movies.filter(m=>m.name.toLowerCase().includes(lower));applySort(sortSelect.value);}        
        function applySort(mode){if(mode==='nameDesc'){filtered.sort((a,b)=>b.name.localeCompare(a.name));}else{filtered.sort((a,b)=>a.name.localeCompare(b.name));}renderGrid();}

        function renderGrid(){
            gridElement.className = `media-grid ${currentSize}`;
            const frag=document.createDocumentFragment();
            filtered.forEach(item=>{const card=document.createElement('div');card.className='media-card';card.innerHTML=`<img class="media-thumb" loading="lazy" src="${item.cover}" alt="${item.name}">`;card.addEventListener('click',()=>showMovieOptions(item));frag.appendChild(card);});
            gridElement.innerHTML='';gridElement.appendChild(frag);
        }

        function showMovieOptions(movie){currentMovie=movie;viewBtn.onclick=()=>{openVideo(getFileUrlForView(currentMovie.path));modal.style.display='none';};downloadBtn.onclick=()=>{downloadMovie(currentMovie);modal.style.display='none';};modal.style.display='flex';}
        function downloadMovie(movie){const link=document.createElement('a');link.href=movie.path;link.download=movie.name;link.click();}

        function openVideo(src){videoSource.src=src;videoPlayer.load();videoModal.style.display='flex';videoPlayer.play();}
        function closeVideo(){videoPlayer.pause();videoSource.src='';videoPlayer.load();videoModal.style.display='none';}
        function closeModal(evt){if(evt.target===modal){modal.style.display='none';}}

        searchInput.addEventListener('input',e=>{clearTimeout(debounceTimer);debounceTimer=setTimeout(()=>applyFilter(e.target.value),150);});
        sortSelect.addEventListener('change',()=>applySort(sortSelect.value));
        videoPlayer.addEventListener('ended',closeVideo);
        init();
    </script>
</body>
</html>
